require('module-alias/register');
const mongoose = require('mongoose');
const { globSync } = require('glob');
const path = require('path');
const client = require("prom-client");

// Make sure we are running node 7.6+
const [major, minor] = process.versions.node.split('.').map(parseFloat);
if (major < 20) {
  console.log('Please upgrade your node.js version at least 20 or greater. ðŸ‘Œ\n ');
  process.exit();
}

// import environmental variables from our variables.env file
require('dotenv').config({ path: '.env' });
require('dotenv').config({ path: '.env.local' });

mongoose.connect(process.env.DATABASE);

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

mongoose.connection.on('error', (error) => {
  console.log(
    `1. ðŸ”¥ Common Error caused issue â†’ : check your .env file first and add your mongodb url`
  );
  console.error(`2. ðŸš« Error â†’ : ${error.message}`);
});



const modelsFiles = globSync('./src/models/**/*.js');

for (const filePath of modelsFiles) {
  require(path.resolve(filePath));
}


// âœ… PROMETHEUS METRICS SETUP (ONLY ADDED CODE BELOW)
// -------------------------------------------------------

// Collect default Node metrics (CPU, RAM, event loop, etc.)
client.collectDefaultMetrics();

// Create histogram for request duration
const httpRequestDuration = new client.Histogram({
  name: "http_request_duration_seconds",
  help: "Duration of HTTP requests in seconds",
  labelNames: ["method", "route", "status_code"],
});

// Load your Express app
const app = require('./app');

// Middleware to measure request durations
app.use((req, res, next) => {
  const end = httpRequestDuration.startTimer();
  res.on("finish", () => {
    end({
      method: req.method,
      route: req.route ? req.route.path : req.path,
      status_code: res.statusCode
    });
  });
  next();
});

// Health endpoint
app.get("/health", (req, res) => {
  res.json({ status: "UP" });
});

// Metrics endpoint
app.get("/metrics", async (req, res) => {
  res.set("Content-Type", client.register.contentType);
  res.end(await client.register.metrics());
});

// -------------------------------------------------------
// END OF METRICS CODE
// --------------------------
// Start our app!

app.set('port', process.env.PORT || 8888);
const server = app.listen(app.get('port'), () => {
  console.log(`Express running â†’ On PORT : ${server.address().port}`);
});
